name: Build Prebuilt Binaries

on:
  # Trigger when a new release is created in the upstream protobuf repository
  repository_dispatch:
    types: [upstream-release]
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: 'Upstream release tag (e.g., v34.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        include:
          # MSVC with static runtime (MT)
          - variant: msvc-mt
            cmake_flags: -DCMAKE_BUILD_TYPE=Release -Dprotobuf_BUILD_TESTS=OFF -Dprotobuf_BUILD_EXAMPLES=OFF -Dprotobuf_WITH_ZLIB=OFF -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_FLAGS_RELEASE="/MT" -DCMAKE_C_FLAGS_RELEASE="/MT"
            artifact_name: protoc-win64-msvc-mt.zip
            setup_msvc: true
          # MSVC with dynamic runtime (MD)
          - variant: msvc-md
            cmake_flags: -DCMAKE_BUILD_TYPE=Release -Dprotobuf_BUILD_TESTS=OFF -Dprotobuf_BUILD_EXAMPLES=OFF -Dprotobuf_WITH_ZLIB=OFF -DCMAKE_CXX_STANDARD=17 -DCMAKE_CXX_FLAGS_RELEASE="/MD" -DCMAKE_C_FLAGS_RELEASE="/MD"
            artifact_name: protoc-win64-msvc-md.zip
            setup_msvc: true
          # MinGW
          - variant: mingw
            cmake_flags: -DCMAKE_BUILD_TYPE=Release -Dprotobuf_BUILD_TESTS=OFF -Dprotobuf_BUILD_EXAMPLES=OFF -Dprotobuf_WITH_ZLIB=OFF -DCMAKE_CXX_STANDARD=17 -DCMAKE_C_FLAGS="-static-libgcc -static-libstdc++" -DCMAKE_CXX_FLAGS="-static-libgcc -static-libstdc++"
            artifact_name: protoc-win64-mingw.zip
            setup_msvc: false
          # Android ARM64
          - variant: android-arm64
            cmake_flags: -DCMAKE_BUILD_TYPE=Release -Dprotobuf_BUILD_TESTS=OFF -Dprotobuf_BUILD_EXAMPLES=OFF -Dprotobuf_WITH_ZLIB=OFF -DCMAKE_CXX_STANDARD=17 -Dprotobuf_BUILD_PROTOC_BINARIES=OFF
            artifact_name: protobuf-android-arm64.zip
            setup_android: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream tag
        id: get_tag
        run: |
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            "tag=${{ inputs.upstream_tag }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          } elseif ('${{ github.event_name }}' -eq 'repository_dispatch') {
            "tag=${{ github.event.client_payload.tag }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          }
        shell: pwsh

      - name: Fetch upstream tag
        run: |
          git remote add upstream https://github.com/protocolbuffers/protobuf.git
          git fetch upstream --tags
          git checkout ${{ steps.get_tag.outputs.tag }}

      - name: Setup MSVC
        if: matrix.setup_msvc
        uses: ilammy/msvc-dev-cmd@v1.12.1

      - name: Setup Ninja
        run: |
          choco install ninja
          echo "C:\Program Files\Ninja" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup MinGW
        if: matrix.variant == 'mingw'
        run: |
          choco install mingw -y
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup Android NDK
        if: matrix.setup_android
        run: |
          $ndkVersion = "r26c"
          $ndkUrl = "https://dl.google.com/android/repository/android-ndk-r26c-windows.zip"
          Invoke-WebRequest -Uri $ndkUrl -OutFile ndk.zip
          Expand-Archive -Path ndk.zip -DestinationPath .
          echo "ANDROID_NDK=$env:GITHUB_WORKSPACE\android-ndk-r26c" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$env:GITHUB_WORKSPACE\android-ndk-r26c" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake (MSVC)
        if: matrix.setup_msvc
        run: |
          cmake -B build -S . -G Ninja ${{ matrix.cmake_flags }} -DCMAKE_INSTALL_PREFIX=install

      - name: Configure CMake (MinGW)
        if: matrix.variant == 'mingw'
        run: |
          cmake -B build -S . -G Ninja ${{ matrix.cmake_flags }} -DCMAKE_INSTALL_PREFIX=install -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DCMAKE_MAKE_PROGRAM=ninja

      - name: Configure CMake (Android ARM64)
        if: matrix.variant == 'android-arm64'
        run: |
          cmake -B build -S . -G Ninja ${{ matrix.cmake_flags }} -DCMAKE_INSTALL_PREFIX=install -DCMAKE_TOOLCHAIN_FILE="$env:ANDROID_NDK\build\cmake\android.toolchain.cmake" -DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24 -DANDROID_STL=c++_shared

      - name: Build
        run: |
          cmake --build build --config Release --parallel

      - name: Install
        run: |
          cmake --install build --config Release --prefix install

      - name: Create package
        run: |
          $version = "${{ steps.get_tag.outputs.tag }}" -replace '^v', ''
          Compress-Archive -Path install\* -DestinationPath ${{ matrix.artifact_name }} -Force
          Write-Host "Created package: ${{ matrix.artifact_name }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}
          retention-days: 7

  create-release:
    needs: build-and-release
    runs-on: windows-2022
    steps:
      - name: Get upstream tag
        id: get_tag
        run: |
          if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
            "tag=${{ inputs.upstream_tag }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          } elseif ('${{ github.event_name }}' -eq 'repository_dispatch') {
            "tag=${{ github.event.client_payload.tag }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
          }
        shell: pwsh

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create combined package
        run: |
          $version = "${{ steps.get_tag.outputs.tag }}" -replace '^v', ''
          $combinedDir = "combined"
          New-Item -ItemType Directory -Path $combinedDir -Force
          
          foreach ($variantDir in Get-ChildItem -Path artifacts -Directory) {
            $variantName = $variantDir.Name
            $prefix = ""
            
            switch ($variantName) {
              "protoc-win64-msvc-mt.zip" { $prefix = "msvc-mt-" }
              "protoc-win64-msvc-md.zip" { $prefix = "msvc-md-" }
              "protoc-win64-mingw.zip" { $prefix = "mingw-" }
              "protobuf-android-arm64.zip" { $prefix = "android-arm64-" }
              default { $prefix = "$variantName-" }
            }
            
            Expand-Archive -Path $variantDir.FullName -DestinationPath temp_extract -Force
            
            foreach ($file in Get-ChildItem -Path temp_extract -Recurse -File) {
              $newName = $prefix + $file.Name
              $relativePath = $file.FullName.Substring((Get-Item temp_extract).FullName.Length)
              $targetDir = $combinedDir + $relativePath.Substring(0, $relativePath.LastIndexOf('\'))
              if (-not (Test-Path $targetDir)) {
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
              }
              Copy-Item -Path $file.FullName -Destination (Join-Path $targetDir $newName)
            }
            
            Remove-Item -Path temp_extract -Recurse -Force
          }
          
          $combinedPackage = "protobuf-${version}-all-variants.zip"
          Compress-Archive -Path $combinedDir\* -DestinationPath $combinedPackage -Force
          Write-Host "Created combined package: $combinedPackage"
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Protobuf ${{ steps.get_tag.outputs.tag }} Prebuilt Binaries
          body: |
            Prebuilt protobuf binaries for ${{ steps.get_tag.outputs.tag }}

            This release includes multiple build variants:

            **Windows x64:**
            - **MSVC-MT**: Built with Microsoft Visual C++ using static runtime library (/MT)
            - **MSVC-MD**: Built with Microsoft Visual C++ using dynamic runtime library (/MD)
            - **MinGW**: Built with MinGW-w64 GCC compiler

            **Android:**
            - **ARM64**: Built with Android NDK r26c for arm64-v8a architecture

            **Combined Package:**
            - **All Variants**: Contains all build variants in a single zip package with prefixes (msvc-mt-, msvc-md-, mingw-, android-arm64-)

            Built from upstream tag: ${{ steps.get_tag.outputs.tag }}
          files: |
            artifacts/*/*.zip
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}